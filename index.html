<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collaborative Planning Widget</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f7f7f7; /* Background to simulate website content */
        }
        /* Custom scrollbar for chat window */
        #chat-feed::-webkit-scrollbar {
            width: 8px;
        }
        #chat-feed::-webkit-scrollbar-thumb {
            background-color: #d1d5db; /* Gray-300 */
            border-radius: 4px;
        }
        /* Hide the initial content until Firebase is ready */
        .hidden-until-ready {
            display: none !important;
        }
    </style>
</head>
<body>

    <!-- Main Chat Container (Modal) -->
    <div id="chat-modal" class="fixed inset-0 z-50 hidden md:flex items-end justify-end p-4 md:p-8" onclick="closeModalOutside(event)">
        <!-- Inner Chat Box -->
        <div id="chat-box" class="bg-white rounded-xl shadow-2xl flex flex-col w-full max-w-sm h-[85vh] md:h-[600px] transform transition-all duration-300 ease-out scale-95 opacity-0">
            <!-- Header -->
            <div class="p-4 border-b border-gray-100 bg-orange-600 text-white rounded-t-xl flex justify-between items-center">
                <h2 class="text-xl font-bold">Collaborative Planning</h2>
                <button onclick="toggleModal()" class="text-white hover:text-gray-100 p-1 rounded-full hover:bg-orange-700 transition duration-150">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>

            <!-- User Info (for tracking collaborators) -->
            <div class="px-4 py-2 bg-orange-100 text-sm text-gray-700 flex justify-between">
                <span>Your ID: <strong id="user-id-display">Loading...</strong></span>
                <span id="auth-status-display" class="font-medium text-xs text-orange-600">Connecting...</span>
            </div>

            <!-- Chat Feed (Messages/Planning Items) -->
            <div id="chat-feed" class="flex-grow p-4 space-y-4 overflow-y-auto bg-gray-50">
                <div id="loading-indicator" class="text-center p-8 text-gray-500">
                    Loading messages...
                </div>
            </div>

            <!-- Input Area -->
            <div class="p-4 border-t border-gray-200">
                <div class="flex items-center space-x-2">
                    <!-- Planning / Add Button -->
                    <button id="add-planning-btn" onclick="showPlanningInput()" class="bg-green-500 hover:bg-green-600 text-white p-3 rounded-full shadow-lg transition duration-150 transform hover:scale-105" title="Start a New Planning Task">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                    </button>

                    <!-- Text Input -->
                    <input type="text" id="message-input" placeholder="Type a message or planning detail..."
                        class="flex-grow p-3 border border-gray-300 rounded-full focus:ring-orange-500 focus:border-orange-500 transition duration-150">
                    
                    <!-- Image Upload Button -->
                    <button onclick="document.getElementById('image-upload').click()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 p-3 rounded-full transition duration-150" title="Upload Image">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                    </button>
                    <input type="file" id="image-upload" accept="image/*" class="hidden" onchange="uploadImage(event)">
                    
                    <!-- Send Button -->
                    <button id="send-btn" onclick="sendMessage()" class="bg-orange-500 hover:bg-orange-600 text-white p-3 rounded-full transition duration-150" title="Send Message">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Chat Logo/Button -->
    <button id="chat-icon" onclick="toggleModal()" class="fixed bottom-6 right-6 z-40 bg-orange-600 text-white p-4 rounded-full shadow-xl hover:bg-orange-700 transition duration-300 transform hover:scale-105">
        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h.01M16 11h.01M7 15h10a1 1 0 011 1v4a1 1 0 01-1 1H7a1 1 0 01-1-1v-4a1 1 0 011-1z"></path></svg>
    </button>
    
    <!-- Firebase Libraries -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, orderBy, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the environment (MANDATORY USE)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let db;
        let auth;
        let userId = 'anonymous';
        let isAuthReady = false;

        // --- CORE FIREBASE INITIALIZATION & AUTH ---

        try {
            // Set Firebase log level for debugging
            setLogLevel('Debug');
            
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            // 1. Check for custom token, otherwise sign in anonymously
            onAuthStateChanged(auth, async (user) => {
                const authStatusDisplay = document.getElementById('auth-status-display');
                if (user) {
                    userId = user.uid;
                    authStatusDisplay.textContent = 'Connected';
                    authStatusDisplay.classList.remove('text-orange-600');
                    authStatusDisplay.classList.add('text-green-600');
                } else if (initialAuthToken) {
                    // Use custom token if provided
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    // Sign in anonymously if no token is available
                    await signInAnonymously(auth);
                }

                // Update UI and start listening for data after auth is resolved
                document.getElementById('user-id-display').textContent = userId.substring(0, 8); // Display first 8 chars for brevity
                isAuthReady = true;
                if (db) {
                    listenForData();
                }
            });

        } catch (error) {
            console.error("Firebase initialization failed:", error);
            document.getElementById('auth-status-display').textContent = 'Error: Check console';
            document.getElementById('auth-status-display').classList.remove('text-orange-600');
            document.getElementById('auth-status-display').classList.add('text-red-600');
        }

        // --- UTILITY FUNCTIONS ---

        function generateUserName(id) {
            // Use the first 4 characters of the ID to create a simple unique identifier
            return 'User-' + id.substring(0, 4);
        }

        // --- UI TOGGLES ---

        window.toggleModal = function() {
            const modal = document.getElementById('chat-modal');
            const box = document.getElementById('chat-box');
            const isHidden = modal.classList.contains('hidden');

            if (isHidden) {
                modal.classList.remove('hidden');
                // Use setTimeout to trigger transition after display block
                setTimeout(() => {
                    box.classList.remove('scale-95', 'opacity-0');
                    box.classList.add('scale-100', 'opacity-100');
                    // Scroll to bottom when opening
                    const feed = document.getElementById('chat-feed');
                    feed.scrollTop = feed.scrollHeight;
                }, 10); 
            } else {
                box.classList.remove('scale-100', 'opacity-100');
                box.classList.add('scale-95', 'opacity-0');
                // Hide modal after transition completes
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 300);
            }
        }

        window.closeModalOutside = function(event) {
            // Only close if the click target is the modal backdrop, not the chat box itself
            if (event.target === document.getElementById('chat-modal')) {
                toggleModal();
            }
        }

        // Show a temporary message in the input field to indicate planning mode
        window.showPlanningInput = function() {
            const input = document.getElementById('message-input');
            input.dataset.mode = 'planning';
            input.placeholder = "Enter planning task details...";
            input.classList.remove('border-gray-300', 'focus:border-orange-500');
            input.classList.add('border-green-500', 'focus:border-green-500');
        }

        function resetInputMode() {
            const input = document.getElementById('message-input');
            input.dataset.mode = 'text';
            input.placeholder = "Type a message or planning detail...";
            input.classList.remove('border-green-500', 'focus:border-green-500');
            input.classList.add('border-gray-300', 'focus:border-orange-500');
        }

        // --- FIRESTORE DATA FUNCTIONS ---

        function getCollectionRef() {
            // Public path for collaborative data
            return collection(db, `artifacts/${appId}/public/data/planning_chat`);
        }

        // Send a regular text message or a planning task
        window.sendMessage = async function() {
            const input = document.getElementById('message-input');
            const content = input.value.trim();
            const mode = input.dataset.mode || 'text';

            if (!content || !isAuthReady) return;

            const message = {
                content: content,
                userId: userId,
                userName: generateUserName(userId),
                timestamp: Date.now(),
            };

            if (mode === 'planning') {
                message.type = 'planning';
                message.isCompleted = false; // Default orange status
            } else {
                message.type = 'text';
            }

            try {
                await addDoc(getCollectionRef(), message);
                input.value = ''; // Clear input
                resetInputMode();
            } catch (e) {
                console.error("Error sending message: ", e);
            }
        }

        // Handle image upload (NOTE: Images are NOT stored in Firestore, only their URL is. 
        // This example uses a simple placeholder URL as file storage is complex for a single-file app.)
        window.uploadImage = async function(event) {
            const file = event.target.files[0];
            if (!file || !isAuthReady) return;

            // In a real application, you would upload the file to a storage service (like Firebase Storage)
            // and get a publicly accessible URL.
            // For this single-file demonstration, we will use a placeholder image URL.

            const tempImageUrl = `https://placehold.co/300x200/5e8d98/FFFFFF?text=Image+by+${generateUserName(userId)}`;
            
            const message = {
                type: 'image',
                content: tempImageUrl,
                userId: userId,
                userName: generateUserName(userId),
                timestamp: Date.now(),
            };

            try {
                await addDoc(getCollectionRef(), message);
                event.target.value = ''; // Clear file input
            } catch (e) {
                console.error("Error posting image: ", e);
            }
        }

        // Toggle the completion status of a planning task
        window.toggleCompletion = async function(docId, currentStatus) {
            if (!isAuthReady) return;
            const docRef = doc(db, getCollectionRef().path, docId);
            try {
                await updateDoc(docRef, {
                    isCompleted: !currentStatus
                });
            } catch (e) {
                console.error("Error updating status: ", e);
            }
        }

        // --- REAL-TIME DATA LISTENER & RENDERING ---

        function listenForData() {
            const q = query(getCollectionRef(), orderBy("timestamp", "asc"));
            
            onSnapshot(q, (snapshot) => {
                const feedElement = document.getElementById('chat-feed');
                feedElement.innerHTML = ''; // Clear previous messages
                document.getElementById('loading-indicator').style.display = 'none';
                
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const docId = doc.id;
                    feedElement.appendChild(renderMessage(data, docId));
                });

                // Always scroll to the bottom on new data
                feedElement.scrollTop = feedElement.scrollHeight;
            }, (error) => {
                console.error("Error listening to Firestore:", error);
                document.getElementById('loading-indicator').textContent = 'Error loading messages.';
            });
        }

        function renderMessage(data, docId) {
            const messageEl = document.createElement('div');
            messageEl.className = 'w-full flex';
            const isCurrentUser = data.userId === userId;
            
            // Basic chat bubble container setup
            const bubbleClasses = isCurrentUser 
                ? 'bg-orange-500 text-white self-end rounded-br-none' 
                : 'bg-gray-200 text-gray-800 self-start rounded-tl-none';
            const alignmentClass = isCurrentUser ? 'justify-end' : 'justify-start';

            if (data.type === 'planning') {
                // --- PLANNING TASK RENDER ---
                const statusClasses = data.isCompleted 
                    ? 'bg-green-100 border-green-500 text-green-700' 
                    : 'bg-orange-100 border-orange-500 text-orange-700';

                messageEl.className = `w-full flex ${alignmentClass}`;
                messageEl.innerHTML = `
                    <div class="planning-card w-full max-w-sm p-3 border-l-4 ${statusClasses} rounded-xl shadow-md transition duration-300 ease-in-out hover:shadow-lg cursor-pointer"
                        onclick="toggleCompletion('${docId}', ${data.isCompleted})">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-xs font-semibold uppercase tracking-wider">
                                ${data.isCompleted ? '✅ Completed' : '⏳ Pending'}
                            </span>
                            <span class="text-xs text-gray-500">${data.userName}</span>
                        </div>
                        <p class="text-base font-medium">${data.content}</p>
                        <span class="text-xs text-gray-400 mt-1 block">${new Date(data.timestamp).toLocaleTimeString()}</span>
                    </div>
                `;

            } else if (data.type === 'image') {
                 // --- IMAGE MESSAGE RENDER ---
                messageEl.className = `w-full flex ${alignmentClass}`;
                messageEl.innerHTML = `
                    <div class="max-w-xs p-2 rounded-xl shadow-md ${bubbleClasses} transition duration-150">
                        <img src="${data.content}" alt="User uploaded image" class="rounded-lg w-full h-auto object-cover border-4 border-white shadow-inner">
                        <span class="text-xs ${isCurrentUser ? 'text-gray-100' : 'text-gray-600'} block mt-1">
                            Posted by ${data.userName} at ${new Date(data.timestamp).toLocaleTimeString()}
                        </span>
                    </div>
                `;

            } else {
                // --- TEXT MESSAGE RENDER ---
                messageEl.className = `w-full flex ${alignmentClass}`;
                messageEl.innerHTML = `
                    <div class="max-w-xs p-3 rounded-xl shadow-md ${bubbleClasses} transition duration-150">
                        <p class="text-sm break-words">${data.content}</p>
                        <div class="text-right text-xs mt-1 ${isCurrentUser ? 'text-gray-200' : 'text-gray-500'}">
                            ${data.userName} - ${new Date(data.timestamp).toLocaleTimeString()}
                        </div>
                    </div>
                `;
            }
            
            return messageEl;
        }

    </script>
</body>
</html>

